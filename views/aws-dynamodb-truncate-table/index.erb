<h1 id="truncate-dynamodb-table">Truncate DynamoDB table</h1>
<p>One of the features that I miss from most RDBMS is the ability to
easily delete all rows, either via <code>DELETE * FROM MyTable</code> or
using <code>TRUNCATE TABLE MyTable</code>. Unfortunately, DynamoDB does
not have such a feature, you have to either, delete your table or remove
all items one at a time.</p>
<p>See <a
href="/posts/aws-dynamodb-delete-tables">aws-dynamodb-delete-tables</a>
if you want to know how to delete tables using the AWS SDK with
Java.</p>
<p>Sometimes however, deleting your tables is not convenient, for
example, you will have to define your schema and specify your capacity
settings again, in this case, and if your tables contains just a few
tens of records, itâ€™s easier to iterate over all your items and remove
them one by one.</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">Iterator</span><span class="op">;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">amazonaws</span><span class="op">.</span><span class="im">services</span><span class="op">.</span><span class="im">dynamodbv2</span><span class="op">.</span><span class="im">AmazonDynamoDB</span><span class="op">;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">amazonaws</span><span class="op">.</span><span class="im">services</span><span class="op">.</span><span class="im">dynamodbv2</span><span class="op">.</span><span class="im">AmazonDynamoDBClientBuilder</span><span class="op">;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">amazonaws</span><span class="op">.</span><span class="im">services</span><span class="op">.</span><span class="im">dynamodbv2</span><span class="op">.</span><span class="im">document</span><span class="op">.</span><span class="im">DynamoDB</span><span class="op">;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">amazonaws</span><span class="op">.</span><span class="im">services</span><span class="op">.</span><span class="im">dynamodbv2</span><span class="op">.</span><span class="im">document</span><span class="op">.</span><span class="im">Table</span><span class="op">;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">amazonaws</span><span class="op">.</span><span class="im">services</span><span class="op">.</span><span class="im">dynamodbv2</span><span class="op">.</span><span class="im">document</span><span class="op">.</span><span class="im">spec</span><span class="op">.</span><span class="im">ScanSpec</span><span class="op">;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">amazonaws</span><span class="op">.</span><span class="im">services</span><span class="op">.</span><span class="im">dynamodbv2</span><span class="op">.</span><span class="im">document</span><span class="op">.</span><span class="im">ItemCollection</span><span class="op">;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">amazonaws</span><span class="op">.</span><span class="im">services</span><span class="op">.</span><span class="im">dynamodbv2</span><span class="op">.</span><span class="im">document</span><span class="op">.</span><span class="im">ScanOutcome</span><span class="op">;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">amazonaws</span><span class="op">.</span><span class="im">services</span><span class="op">.</span><span class="im">dynamodbv2</span><span class="op">.</span><span class="im">document</span><span class="op">.</span><span class="im">Item</span><span class="op">;</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">amazonaws</span><span class="op">.</span><span class="im">services</span><span class="op">.</span><span class="im">dynamodbv2</span><span class="op">.</span><span class="im">document</span><span class="op">.</span><span class="im">PrimaryKey</span><span class="op">;</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">amazonaws</span><span class="op">.</span><span class="im">auth</span><span class="op">.</span><span class="im">profile</span><span class="op">.</span><span class="im">ProfileCredentialsProvider</span><span class="op">;</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">amazonaws</span><span class="op">.</span><span class="im">regions</span><span class="op">.</span><span class="im">Regions</span><span class="op">;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> Truncates table<span class="co">,</span> handy in testing and debugging<span class="co">.</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> Credentials are read from <span class="co">~/.</span>aws<span class="co">/</span>credentials<span class="co">.</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> See http<span class="co">://</span>docs<span class="co">.</span>aws<span class="co">.</span>amazon<span class="co">.</span>com<span class="co">/</span>sdk<span class="co">-</span>for<span class="co">-</span>java<span class="co">/</span>v1<span class="co">/</span>developer<span class="co">-</span>guide<span class="co">/</span>setup<span class="co">-</span>credentials<span class="co">.</span>html for more</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> details<span class="co">.</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> TableCleaner <span class="op">{</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> DynamoDB db<span class="op">;</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">TableCleaner</span><span class="op">(</span>DynamoDB db<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">db</span> <span class="op">=</span> db<span class="op">;</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>args<span class="op">.</span><span class="fu">length</span> <span class="op">!=</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">err</span><span class="op">.</span><span class="fu">printf</span><span class="op">(</span><span class="st">&quot;Usage: java TableCleaner &lt;table:partition_key[:range_key]&gt;&quot;</span><span class="op">);</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">exit</span><span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>        AmazonDynamoDB client <span class="op">=</span> AmazonDynamoDBClientBuilder<span class="op">.</span><span class="fu">standard</span><span class="op">()</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">withCredentials</span><span class="op">(</span><span class="kw">new</span> <span class="fu">ProfileCredentialsProvider</span><span class="op">())</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">withRegion</span><span class="op">(</span>Regions<span class="op">.</span><span class="fu">US_WEST_2</span><span class="op">)</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>        DynamoDB db <span class="op">=</span> <span class="kw">new</span> <span class="fu">DynamoDB</span><span class="op">(</span>client<span class="op">);</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>        <span class="kw">new</span> <span class="fu">TableCleaner</span><span class="op">(</span>db<span class="op">).</span><span class="fu">truncateTable</span><span class="op">(</span>args<span class="op">[</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">truncateTable</span><span class="op">(</span><span class="bu">String</span> tableSpec<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span><span class="op">[]</span> tokens <span class="op">=</span> tableSpec<span class="op">.</span><span class="fu">split</span><span class="op">(</span><span class="st">&quot;:&quot;</span><span class="op">);</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>tokens<span class="op">.</span><span class="fu">length</span> <span class="op">==</span> <span class="dv">2</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>                <span class="fu">truncateTable</span><span class="op">(</span>tokens<span class="op">[</span><span class="dv">0</span><span class="op">],</span> tokens<span class="op">[</span><span class="dv">1</span><span class="op">]);</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>tokens<span class="op">.</span><span class="fu">length</span> <span class="op">==</span> <span class="dv">3</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>                <span class="fu">truncateTable</span><span class="op">(</span>tokens<span class="op">[</span><span class="dv">0</span><span class="op">],</span> tokens<span class="op">[</span><span class="dv">1</span><span class="op">],</span> tokens<span class="op">[</span><span class="dv">2</span><span class="op">]);</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>            e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">truncateTable</span><span class="op">(</span><span class="bu">String</span> tableName<span class="op">,</span> <span class="bu">String</span> hashKeyName<span class="op">,</span> <span class="bu">String</span> rangeKeyName<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>        Table table <span class="op">=</span> db<span class="op">.</span><span class="fu">getTable</span><span class="op">(</span>tableName<span class="op">);</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>        ScanSpec spec <span class="op">=</span> <span class="kw">new</span> <span class="fu">ScanSpec</span><span class="op">();</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>        ItemCollection<span class="op">&lt;</span>ScanOutcome<span class="op">&gt;</span> items <span class="op">=</span> table<span class="op">.</span><span class="fu">scan</span><span class="op">(</span>spec<span class="op">);</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Iterator</span><span class="op">&lt;</span>Item<span class="op">&gt;</span> it <span class="op">=</span> items<span class="op">.</span><span class="fu">iterator</span><span class="op">();</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(</span>it<span class="op">.</span><span class="fu">hasNext</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>            Item item <span class="op">=</span> it<span class="op">.</span><span class="fu">next</span><span class="op">();</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> hashKey <span class="op">=</span> item<span class="op">.</span><span class="fu">getString</span><span class="op">(</span>hashKeyName<span class="op">);</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> rangeKey <span class="op">=</span> item<span class="op">.</span><span class="fu">getString</span><span class="op">(</span>rangeKeyName<span class="op">);</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>            PrimaryKey key <span class="op">=</span> <span class="kw">new</span> <span class="fu">PrimaryKey</span><span class="op">(</span> hashKeyName<span class="op">,</span> hashKey<span class="op">,</span> rangeKeyName<span class="op">,</span> rangeKey<span class="op">);</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>            table<span class="op">.</span><span class="fu">deleteItem</span><span class="op">(</span>key<span class="op">);</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">printf</span><span class="op">(</span><span class="st">&quot;Deleted item with key: &lt;</span><span class="sc">%s</span><span class="st">, </span><span class="sc">%s</span><span class="st">&gt;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> hashKey<span class="op">,</span> rangeKey<span class="op">);</span></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">truncateTable</span><span class="op">(</span><span class="bu">String</span> tableName<span class="op">,</span> <span class="bu">String</span> hashKeyName<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>        Table table <span class="op">=</span> db<span class="op">.</span><span class="fu">getTable</span><span class="op">(</span>tableName<span class="op">);</span></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>        ScanSpec spec <span class="op">=</span> <span class="kw">new</span> <span class="fu">ScanSpec</span><span class="op">();</span></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>        ItemCollection<span class="op">&lt;</span>ScanOutcome<span class="op">&gt;</span> items <span class="op">=</span> table<span class="op">.</span><span class="fu">scan</span><span class="op">(</span>spec<span class="op">);</span></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Iterator</span><span class="op">&lt;</span>Item<span class="op">&gt;</span> it <span class="op">=</span> items<span class="op">.</span><span class="fu">iterator</span><span class="op">();</span></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(</span>it<span class="op">.</span><span class="fu">hasNext</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>            Item item <span class="op">=</span> it<span class="op">.</span><span class="fu">next</span><span class="op">();</span></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> hashKey <span class="op">=</span> item<span class="op">.</span><span class="fu">getString</span><span class="op">(</span>hashKeyName<span class="op">);</span></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>            PrimaryKey key <span class="op">=</span> <span class="kw">new</span> <span class="fu">PrimaryKey</span><span class="op">(</span>hashKeyName<span class="op">,</span> hashKey<span class="op">);</span></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>            table<span class="op">.</span><span class="fu">deleteItem</span><span class="op">(</span>key<span class="op">);</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">printf</span><span class="op">(</span><span class="st">&quot;Deleted item with key: </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> hashKey<span class="op">);</span></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<!-- TODO: Explain how to set up the SDK to compile the program properly.  -->
<p>Compile</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"></code></pre></div>
<p>You need to provide the name of your partition key and the range key
if your table has one, for example:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">java</span> TableCleaner MyTable:PartionKeyName:RangeKeyName</span></code></pre></div>
